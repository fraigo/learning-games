<!-- text-template -->
<script type="text/x-template" id="app-content-template">
    <div class="app-content" :style="sectionStyle()">
        <h1 v-if="position!=-3" :audio="section.audio!=null" @click="play(section.audio,null,section.title)">{{section.title}}</h1>
        <div class="section-image" :style="imageStyle(section)"></div>
        <transition-group name="fade">
        <div class="option-container levels" :count="section.levels.length" :key="'levels'" v-if="currentLevel==0">
            <div v-for="(level, idx) in section.levels" :audio="level.audio!=null" :key="level.label" class="option" :style="levelStyle(level)" @click="start(idx+1)">
                <div>{{level.label}}</div>
                <div class="level-info" v-if="level.timer>0"><span class="material-icons">timer</span>{{level.timer}}s</div>
                <div class="levelstars" is="stars" :stars="levelStars(level,idx)"></div>
            </div>
        </div>
        <div v-for="(slide,idx) in currentSlides"  :key="slide.title?slide.title:slide.image" v-show="idx==position && !hide">
            <div>
                <h2 v-if="slide.title" :style="titleStyle" :audio="slide.audio!=null"  @click="play(slide.audio,null,slide.title)">{{slide.title}}</h2>
                <div class="title-image" :style="imageStyle(slide)"></div>
                <div class="option-container">
                    <div class="option" :result="option.result" :audio="option.audio!=null"  :key="idx1" @click.stop="verifyOption(slide,idx1)" v-for="(option,idx1) in slide.options" :style="optionStyle(option,idx1)">
                        {{option.label}}
                    </div>
                </div>
            </div>
        </div>
        </transition-group>
        <div class="results" v-if="position==-1 && currentLevel>0">
            <h2>Terminado!</h2>
            <div class="results-content">
                <div>Correctas<br><span class="correct">{{this.correct}}</span></div>
                <div>Errores<br><span class="error">{{this.errors}}</span></div>
                <div class="stars" is="stars" :stars="stars" :size="40" :animated="true" :key="stars+40"></div>
            </div>
        </div>
        <div class="status" v-if="position>=0"><span class="timer" :seconds="timerSeconds" v-if="this.timer">{{timerSeconds}}</span></div>
    </div>
</script>
<script type="text/javascript">
Vue.component('app-content', {
    template: '#app-content-template',
    data: function(){
        return {
            correct: 0,
            errors: 0,
            total: 0,
            score: 0,
            stars: 0,
            currentSlides: [],
            orders: [],
            position: -2,
            sorted: false,
            timer: false,
            currentLevel: 0,
            timerLength: 5000,
            timerSeconds: 0,
            levelData: {
                levelStars: []
            },
            audios: {}
        }
    },
    props: { 
        section: Object,
        parent: Object,
        baseurl: String
    },
    mounted:function(){
        var self = this
        this.total = this.section.slides.length
        for (var index = 0; index < 10; index++) {
            this.orders.push(Math.floor(Math.random() * 10))
        }
        var levelData = localStorage.getItem('leveldata_'+this.section.id)
        if (levelData && levelData != '') {
            this.levelData = JSON.parse(levelData)
        }
        for (var index = 0; index < this.section.levels.length; index++) {
            if (!this.levelData.levelStars[index]) {
                this.levelData.levelStars[index]=0
            }
        }
        var audios={}
        this.loadAudio("correcto")
        this.loadAudio("nivel")
        this.loadAudio("incorrecto")
        this.loadAudio("lo_lograste")
        this.loadAudio("dos")
        this.loadAudio("tres")
        this.loadAudio("estrellas")
        this.loadAudio("tick")
        this.loadAudio("tiempo")
        if (this.section.preloadAudio){
            for(var key in this.section.preloadAudio){
                this.loadAudio(this.section.preloadAudio[key])
            }
        }
        this.loadAudio(this.section.audio)
        this.loadAudio(this.wordExpression(this.section.title))
        for(var key in this.section.levels){
            this.loadAudio(this.section.levels[key].audio)
            this.loadAudio(this.wordExpression(this.section.levels[key].label))
        }
        for(var key in this.section.slides){
            this.loadAudio(this.section.slides[key].audio)
            this.loadAudio(this.wordExpression(this.section.slides[key].title))
            for(var key1 in this.section.slides[key].options){
                this.loadAudio(this.section.slides[key].options[key1].audio)
                this.loadAudio(this.wordExpression(this.section.slides[key].options[key1].label))
            }
        }
        console.log(self.audios)
        audioEngine.loadList(this.audios, function(result) {
            // console.log('result',result,self.audios)
        }, function(id, error) {
            delete self.audios[id]
        })
    },
    methods: {
        loadAudio: function(audios) {
            if (!audios) {
                return
            }
            if (typeof audios == 'string') {
                this.audios[audios]="audio/"+audios+".wav"
            } else {
                for (var idx in audios){
                    this.audios[audios[idx]]="audio/"+audios[idx]+".wav"
                }
            }
        },
        save: function() {
            localStorage.setItem('leveldata_'+this.section.id, JSON.stringify(this.levelData))
        },
        menu: function() {
            clearInterval(this.timerProc)
            this.currentLevel = 0
            this.position = -1
        },
        toWords: function(expr){
            if (expr == 'x'){
                return ["por"]
            }
            if (typeof expr == 'number'){
                expr = "" + expr
            }
            if (expr && expr.trim() != '' && !isNaN(expr.trim())){
                var num = Number(expr)
                var nums = ["cero","uno","dos","tres","cuatro","cinco","seis","siete","ocho","nueve","diez",
                "once","doce","trece","catorce","quince",null,null,null,null,"veinte"]
                var decs = ["","","veinte","treinta","cuarenta","cincuenta","sesenta","setenta","ochenta","noventa"]
                var numText = nums[num]
                if (numText){
                    return [numText]
                }else{
                    if (num>15 && num<20){
                        return ["dieci"].concat(this.toWords(num-10))
                    } else
                    if (num%10==0){
                        var deci = decs[Math.floor(num/10)]
                        if (deci){
                            return [deci]
                        }
                    } else
                    if (num<30){
                        return ["veinti"].concat(this.toWords(num%10))
                    } else
                    if (num<100){
                        return [decs[Math.floor(num/10)],"y"].concat(this.toWords(num%10))
                    }
                }
            }
            return [expr]
        },
        wordExpression: function(expr, check){
            if (!expr){
                return []
            }
            if (typeof expr == 'number') {
                expr = "" + expr
            }
            var parts = expr.split(" ")
            var wordList = []
            for (var index = 0; index < parts.length; index++) {
                var words = this.toWords(parts[index].toLowerCase());
                for (var idx1 = 0; idx1 < words.length; idx1++) {
                    var word = words[idx1]
                    if (word!='' && (!check || this.audios[word])){
                        wordList.push(word)
                    }
                }
            }
            return wordList
        },
        playExpression: function(expr, include){
            var audios = this.wordExpression(expr, true)
            if (include) {
                var includeExpr = this.wordExpression(include, true)
                console.log('include', include, includeExpr)
                audios = audios.concat(includeExpr)
            }
            this.play(audios)
        },
        play: function(audios,include,expr) {
            console.log('play', audios, include, expr)
            if ((audios==null || audios.length==0) && expr){
                this.playExpression(expr, include)
                return
            }
            this.$emit('status',JSON.stringify(audios))
            if (!audios && !include) return;
            if (include && !audios) {
                audios = []
            }
            if (typeof audios == 'string') {
                audios = [audios]
            }
            if (include) {
                audios.push(include)
            }
            var time = 0
            for(var idx=0; idx< audios.length; idx++) {
                setTimeout(function(audio){ audioEngine.play(audio)},time,audios[idx])
                time+=audioEngine.duration(audios[idx])-100
            }
        },
        restart: function() {
            this.position = -3
            clearInterval(this.timerProc)
            setTimeout(function(self){
                self.start(self.currentLevel)
            },1000,this)
        },
        start: function (levelNum) {
            var levelData = this.section.levels[levelNum-1]
            this.play(levelData.audio,null,levelData.label)
            if (levelData.hash){
                this.$emit('url',levelData.hash)
                return
            }
            if (levelData.url){
                this.$emit('url',levelData.url)
                return
            }
            this.position = -1
            this.sorted = levelData.sorted
            this.timer = levelData.timer
            this.currentLevel = levelNum
            this.correct = 0
            this.errors = 0
            var tmpSlides = JSON.parse(JSON.stringify(this.section.slides))
            if (!this.sorted) {
                this.currentSlides = tmpSlides.sort(function(a,b){
                    return Math.floor(Math.random()*2) -1;
                })
            } else {
                this.currentSlides = tmpSlides
            }
            this.nextSlide()
            this.$emit('state','started')
        },
        nextSlide: function () {
            clearInterval(this.timerProc)
            this.hide = false
            if (this.position + 1 == this.currentSlides.length){
                this.endSection()
                this.position=-1
                this.$emit('state','finish')
                return
            }
            this.$emit('state','next')
            this.position++
            this.$forceUpdate()
            if (this.timer){
                this.timerSeconds=this.timer
                this.timerProc=setInterval(function (self) {
                    console.log(self.$el)
                    self.play("tick")
                    self.timerSeconds--
                    if (self.timerSeconds==0){
                        self.hide = true
                        self.play("tiempo")
                        clearInterval(this.timerProc)
                        setTimeout(function(){
                            self.nextSlide()
                        },1100)
                    }
                },1000, this)
            }
            this.$emit('status',(this.position+1) + " / " + this.total)
        },
        endSection: function () {
            var points = (this.correct-this.errors)
            this.score = points/this.total
            console.log('score', points, this.score)
            this.stars = 0
            if (this.score == 1){
                this.stars = 3
            }
            else if (this.score >0.6){
                this.stars = 2
            }
            else if (this.score > 0.1){
                this.stars = 1
            }
            if (!this.levelData.levelStars[this.currentLevel-1]){
                this.levelData.levelStars[this.currentLevel-1]=0
            }
            this.levelData.levelStars[this.currentLevel-1] = Math.max(this.stars, this.levelData.levelStars[this.currentLevel-1])
            this.save()
            setTimeout(function(self){
                if (self.stars>0){
                    if (self.stars==3){
                    self.play(["lo_lograste","tres","estrellas"])
                    } else if (self.stars==2){
                        self.play(["lo_lograste","dos","estrellas"])
                    } else {
                        self.play("lo_lograste")
                    }

                }
            },1000, this)
            setTimeout(function(self){
                self.currentLevel = 0
            },3000, this)
        },
        verifyOption: function(slide, idx){
            var option = slide.options[idx]
            var answer = slide.answer
            var self = this
            var currentOptions=this.currentSlides[this.position].options      
            if (currentOptions[idx].result>0){
                return
            }
            if  (slide.locked == true) {
                return
            }
            var response = option.value ? option.value : option.label
            if (response == answer) {
                currentOptions[idx].result = 1
                this.correct++
                slide.locked = true
                clearInterval(this.timerProc)
                this.play(option.audio,"correcto",option.label)
                setTimeout(function () {
                    self.nextSlide()
                },800)
            } else {
                this.errors++
                currentOptions[idx].result = 2
                this.play(option.audio,"incorrecto",option.label)
            }
            this.$forceUpdate()
        },
        sectionStyle: function() {
            return this.section.style?this.section.style:(this.parent&&this.parent.style)
        },
        levelStyle: function(level) {
            var section = this.section
            var parentStyle = (this.parent && this.parent.levelStyle) ? this.parent.levelStyle : {}
            var baseStyle = section.levelStyle ? JSON.parse(JSON.stringify(section.levelStyle)) : JSON.parse(JSON.stringify(parentStyle))
            var bg = section.levelCover ? section.levelCover : level.cover
            if (bg) {
                if (!bg.startsWith("http")){
                    bg=this.baseurl+bg
                }
                baseStyle.backgroundImage = 'url("'+ bg  + '")'
                baseStyle.backgroundSize = "cover"
                baseStyle.backgroundRepeat = "no-repeat"
                baseStyle.backgroundPosition = "center bottom"
            }
            if (level.style) {
                for (var key in level.style) {
                    baseStyle[key] = level.style[key]
                }
            }
            return baseStyle
        },
        optionStyle: function(option, idx) {
            var parentStyle = (this.parent && this.parent.optionStyle) ? this.parent.optionStyle : {}
            var baseStyle = this.section.optionStyle ? JSON.parse(JSON.stringify(this.section.optionStyle)) : parentStyle
            baseStyle["order"]=this.orders[idx]
            var bg = this.section.optionCover ? this.section.optionCover : option.cover
            if (bg) {
                if (!bg.startsWith("http")){
                    bg=this.baseurl+bg
                }
                baseStyle.backgroundImage = 'url("'+ bg  + '")'
                baseStyle.backgroundSize = "cover"
                baseStyle.backgroundRepeat = "no-repeat"
                baseStyle.backgroundPosition = "center bottom"
            }
            if (option.style) {
                for (var key in option.style) {
                    baseStyle[key] = option.style[key]
                }
            }
            return baseStyle
        },
        titleStyle: function(){
            return this.section.titleStyle
        },
        imageStyle: function(item){
            var style = this.section.imageStyle ? JSON.parse(JSON.stringify(this.section.imageStyle)) : {}
            var bg = item.image
            if (bg){
                if (!bg.startsWith("http")){
                    bg=this.baseurl+bg
                }
                style.backgroundImage= 'url("'+ bg  + '")'
                style.backgroundSize='contain'
                style.backgroundRepeat='no-repeat'
                style.backgroundPosition='center center'
            }
            return style
        },
        levelStars: function(level, idx){
            if (level.hash){
                var stars = localStorage.getItem('leveldata_'+level.hash)
                if (stars && stars!='') {
                    var data = JSON.parse(stars)
                    var count = 0
                    var total = 0
                    for(var idx in data.levelStars) {
                        total += 3
                        count += data.levelStars[idx]
                    }
                    console.log('levelstars',level.hash,count,data.levelStars)
                    if (total>0){
                        return Math.max(1,Math.floor(count*3/total))
                    }
                }
            }
            return this.levelData.levelStars[idx]
        }
    },
    computed:{
        
    },
    watch:{
    }

});
</script>
<style>
body{
    font-size: 20px;
}
*[audio='true']{
    position: relative;
}
*[audio='true']:before{
    content:" ";
    width: 20px;
    height: 20px;
    position: absolute;
    background-image: url('img/audio.svg');
    background-size: contain;
    right: 4px;
    top: 4px;
}
.app-content{
    text-align: center;
}
.app-content h1{
    font-size: 2.5em;
    margin: 0.2em auto;
    display: inline-block;
}
.app-content h1[audio='true']{
    padding-right: 30px;
}
.app-content h2{
    font-size: 2.5em;
    display: inline-block;
    background-color: #44C;
    color: #fff;
    padding: 8px;
    border-radius: 8px;
}
.app-content h2[audio='true']{
    padding-right: 30px;
}
.option-container{
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
}
.option-container .option{
    position: relative;
    min-width: 100px;
    min-height: 100px;
    width: 13vw;
    height: 13vw;
    display: flex;
    justify-content: center;
    align-items: center;
    border: 2px solid #888;
    margin: 8px;
    border-radius: 12px;
    cursor: pointer;
    font-size: 2em;
    padding: 0 8px;
    max-height: 33vh;
}
.option-container .option[result='1']{
    border: 4px solid green;
    color: green;
    background-color: #dfd;
}
.option-container .option[result='2']{
    border: 4px solid red;
    color: red;
    background-color: #fdd;
}
.results{
    font-size: 1.2em;
}
.results-content{
    background-color: rgb(255,255,255);
    color: #222;
    padding: 12px;
    max-width: 90%;
    margin: 0 auto;
    border-radius: 7px;
    border: 1px solid #eee;
}
.stars{
    font-size: 3rem;
}
.levels{
    position: relative;
}
.levels .option{
    font-size: 1.5em;
    flex-direction: column;
    justify-content: flex-start;
    width: 19vw;
    height: 19vw;
}
.levels .option .levelstars{
    position: absolute; 
    bottom: 8px;
    width: 100%;
    left: 0;
}
.levels[count='6'] .option{
    width: 26vw;
    height: 26vw;
}
.levels[count='7'] .option,
.levels[count='8'] .option{
    width: 20vw;
    height: 20vw;
}
.levels[count='9'] .option{
    width: 26vw;
    height: 26vw;
    max-height: 30vh;
}
.levels[count='10'] .option{
    width: 19vw;
    height: 19vw;
}
.levels .option > div:first-child{
    padding-top: 8%;
}
.levelstars star{
    font-size: 1rem;
}
.level-info{
    display: flex;
    justify-content: center;
    align-items: center;
}
.title-image{
    height:25vh;
}
.error{
    color: #C00;
}
.correct{
    color: #080;
}
.timer{
    display: inline-block;
    width: 2em;
    height: 2em;
    line-height: 2em;
    font-size: 2em;
    border: 2px solid #44C;
    background-color: #eee;
    color: #44C;
    border-radius: 99% 99%;
    text-align:center;
}
.timer[seconds='2'] {
    color: #C60;
    border: 2px solid #C60;
}
.timer[seconds='1'] {
    color: #C00;
    border: 2px solid #C00;
}
.status{
    text-align: right;
    padding: 8px;
    box-sizing: border-box;
    position:absolute;
    bottom: 0;
    left:0;
    width:100%;
    z-index: 2;
}
.levelstars .star-icon{
    width: 40px;
    height: 40px;    
}
.stars{
    height: 60px;
    margin-bottom: 20px;
}
.stars .star-icon{
    width: 80px;
    height: 80px;    
}
@media (max-width: 1023px) {
    body{
        font-size: 18px;
    }
    .levels .option{
        font-size: 1.2em;
    }
    .stars .star-icon{
        width: 60px;
        height: 60px;    
    }
}
@media (max-width: 767px) {
    body{
        font-size: 16px;
    }
    .app-content h1, .app-content h2{
        font-size: 1.5em;
    }
    .levels .option{
        font-size: 1em;
    }
}
@media (max-width: 400px) {
    .levelstars .star-icon{
        width: 22px;
        height: 22px;    
    }
    .levels{
        max-width: 380px;
        margin: 0 auto;
    }
    .levels .option{
        font-size: 1rem;
    }
    .title-image{
        height: 22vh;
    }
    .levels[count='9'] .option{
        width: 17vw;
        height: 17vw;
    }
}
@media (max-width: 360px) {
    .app-content{
        padding: 6px;
    }
    .levels .option, .option-container .option{
        margin: 1px;
    }
}

</style>