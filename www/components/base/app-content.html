<!-- text-template -->
<script type="text/x-template" id="app-content-template">
    <div class="app-content" :style="sectionStyle()">
        <h1 v-if="position!=-3">{{section.title}}</h1>
        <transition-group name="fade">
        <div class="option-container levels" :key="'levels'" v-if="currentLevel==0">
            <div v-for="(level, idx) in section.levels" :key="level.label" class="option" :style="levelStyle(level)" @click="start(idx+1)">
                <div>{{level.label}}</div>
                <div class="levelstars"><span v-if="levelData.levelStars[idx]>=1">⭐️</span><span v-if="levelData.levelStars[idx]>=2">⭐️</span><span v-if="levelData.levelStars[idx]>=3">⭐️</span></div>
            </div>
        </div>
        <div v-for="(slide,idx) in currentSlides" :key="slide.title" v-show="idx==position">
            <div>
                <h2>{{slide.title}}</h2>
                <div class="option-container">
                    <div class="option" :result="option.result" :key="idx1" @click="verifyOption(slide,idx1)" v-for="(option,idx1) in slide.options" :style="optionStyle(option,idx1)">
                        {{option.label}}
                    </div>
                </div>
            </div>
        </div>
        </transition-group>
        <div class="results" v-if="position==-1 && currentLevel>0">
            <h2>Terminado!</h2>
            <div>
                <div>Correctas<br><span class="correct">{{this.correct}}</span></div>
                <div>Errores<br><span class="error">{{this.errors}}</span></div>
                <div class="stars"><span v-if="stars>=1">⭐️</span><span v-if="stars>=2">⭐️</span><span v-if="stars>=3">⭐️</span></div>
            </div>
        </div>
        <div class="status" v-if="position>=0"><span class="timer" :seconds="timerSeconds" v-if="this.timer">{{timerSeconds}}</span></div>
    </div>
</script>
<script type="text/javascript">
Vue.component('app-content', {
    template: '#app-content-template',
    data: function(){
        return {
            correct: 0,
            errors: 0,
            total: 0,
            score: 0,
            stars: 0,
            currentSlides: [],
            orders: [],
            position: -2,
            sorted: false,
            timer: false,
            currentLevel: 0,
            timerLength: 5000,
            timerSeconds: 0,
            levelData: {
                levelStars: []
            },
        }
    },
    props: { 
        section: Object,
        parent: Object,
        baseurl: String
    },
    mounted:function(){
        this.total = this.section.slides.length
        for (var index = 0; index < 10; index++) {
            this.orders.push(Math.floor(Math.random() * 10))
        }
        var levelData = localStorage.getItem('leveldata_'+this.section.id)
        if (levelData && levelData != '') {
            this.levelData = JSON.parse(levelData)
        }
        for (var index = 0; index < this.section.levels.length; index++) {
            if (!this.levelData.levelStars[index]) {
                this.levelData.levelStars[index]=0
            }
        }
    },
    methods: {
        save: function() {
            localStorage.setItem('leveldata_'+this.section.id, JSON.stringify(this.levelData))
        },
        menu: function() {
            clearInterval(this.timerProc)
            this.currentLevel = 0
            this.position = -1
        },
        restart: function() {
            this.position = -3
            setTimeout(function(self){
                self.start(self.currentLevel)
            },1000,this)
        },
        start: function (level) {
            var levelData = this.section.levels[level-1]
            if (levelData.hash){
                document.location.hash="#"+levelData.hash
                return
            }
            if (levelData.url){
                document.location.hash="#"+levelData.url
                return
            }
            this.position = -1
            this.sorted = levelData.sorted
            this.timer = levelData.timer
            this.currentLevel = level
            this.correct = 0
            this.errors = 0
            var tmpSlides = JSON.parse(JSON.stringify(this.section.slides))
            if (!this.sorted) {
                this.currentSlides = tmpSlides.sort(function(a,b){
                    return Math.floor(Math.random()*2) -1;
                })
            } else {
                this.currentSlides = tmpSlides
            }
            this.nextSlide()
            this.$emit('state','started')
        },
        nextSlide: function () {
            clearInterval(this.timerProc)
            if (this.position + 1 == this.currentSlides.length){
                this.endSection()
                this.position=-1
                this.$emit('state','finish')
                return
            }
            this.$emit('state','next')
            this.position++
            this.$forceUpdate()
            if (this.timer){
                this.timerSeconds=this.timer
                this.timerProc=setInterval(function (self) {
                    self.timerSeconds--
                    if (self.timerSeconds==0){
                        self.nextSlide()
                    }
                },1000, this)
            }
            this.$emit('status',(this.position+1) + " / " + this.total)
        },
        endSection: function () {
            var points = (this.correct-this.errors)
            this.score = points/this.total
            console.log('score', points, this.score)
            this.stars = 0
            if (this.score == 1){
                this.stars = 3
            }
            else if (this.score >0.6){
                this.stars = 2
            }
            else if (this.score > 0.3){
                this.stars = 1
            }
            if (!this.levelData.levelStars[this.currentLevel-1]){
                this.levelData.levelStars[this.currentLevel-1]=0
            }
            this.levelData.levelStars[this.currentLevel-1] = Math.max(this.stars, this.levelData.levelStars[this.currentLevel-1])
            this.save()
            setTimeout(function(self){
                self.currentLevel = 0
            },3000, this)
        },
        verifyOption: function(slide, idx){
            var option = slide.options[idx]
            var answer = slide.answer
            var self = this
            var currentOptions=this.currentSlides[this.position].options      
            if (currentOptions[idx].result>0){
                return
            }
            if  (slide.locked == true) {
                return
            }
            console.log(option.label, answer)
            if (option.label == answer) {
                currentOptions[idx].result = 1
                this.correct++
                slide.locked = true
                clearInterval(this.timerProc)
                setTimeout(function () {
                    self.nextSlide()
                },800)
            } else {
                this.errors++
                currentOptions[idx].result = 2
            }
            this.$forceUpdate()
        },
        sectionStyle: function() {
            return this.section.style?this.section.style:(this.parent&&this.parent.style)
        },
        levelStyle: function(level) {
            var section = this.section
            var parentStyle = (this.parent && this.parent.levelStyle) ? this.parent.levelStyle : {}
            var baseStyle = section.levelStyle ? JSON.parse(JSON.stringify(section.levelStyle)) : JSON.parse(JSON.stringify(parentStyle))
            var bg = section.levelCover ? section.levelCover : level.cover
            if (bg) {
                if (!bg.startsWith("http")){
                    bg=this.baseurl+bg
                }
                baseStyle.backgroundImage = 'url("'+ bg  + '")'
                baseStyle.backgroundSize = "cover"
                baseStyle.backgorundRepeat = "no-repeat"
            }
            if (level.style) {
                for (var key in level.style) {
                    baseStyle[key] = level.style[key]
                }
            }
            return baseStyle
        },
        optionStyle: function(option, idx) {
            var parentStyle = (this.parent && this.parent.optionStyle) ? this.parent.optionStyle : {}
            var baseStyle = this.section.optionStyle ? JSON.parse(JSON.stringify(this.section.optionStyle)) : parentStyle
            baseStyle["order"]=this.orders[idx]
            var bg = this.section.optionCover ? this.section.optionCover : option.cover
            if (bg) {
                baseStyle.backgroundImage = 'url("'+ bg  + '")'
                baseStyle.backgroundSize = "cover"
                baseStyle.backgorundRepeat = "no-repeat"
            }
            if (option.style) {
                for (var key in option.style) {
                    baseStyle[key] = option.style[key]
                }
            }
            return baseStyle
        }
    },
    computed:{
        
    },
    watch:{
    }

});
</script>
<style>
.app-content{
    padding: 8px;
    text-align: center;
}
.app-content h2{
    font-size: 2.5em;
    display: inline-block;
    background-color: #44C;
    color: #fff;
    padding: 8px;
    border-radius: 8px;
}
.option-container{
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
}
.option-container .option{
    min-width: 100px;
    min-height: 100px;
    width: 13vw;
    height: 13vw;
    display: flex;
    justify-content: center;
    align-items: center;
    border: 2px solid #888;
    margin: 8px;
    border-radius: 12px;
    cursor: pointer;
    font-size: 2em;
    padding: 0 8px;
}
.option-container .option[result='1']{
    border: 2px solid green;
    color: green;
    background-color: #dfd;
}
.option-container .option[result='2']{
    border: 2px solid red;
    color: red;
    background-color: #fdd;
}
.results{
    font-size: 1.2em;
}
.stars{
    font-size: 3rem;
}
.levels{
    position: relative;
}
.levels .option{
    font-size: 1em;
    flex-direction: column;
    justify-content: flex-start;
    width: 16vw;
    height: 16vw;
}
.levels .option > div:first-child{
    padding-top: 8%;
}
.levelstars star{
    font-size: 1rem;
}
.error{
    color: #C00;
}
.correct{
    color: #080;
}
.timer{
    display: inline-block;
    width: 2em;
    height: 2em;
    line-height: 2em;
    font-size: 2em;
    border: 2px solid #44C;
    background-color: #eee;
    color: #44C;
    border-radius: 99% 99%;
    text-align:center;
}
.timer[seconds='2'] {
    color: #C60;
    border: 2px solid #C60;
}
.timer[seconds='1'] {
    color: #C00;
    border: 2px solid #C00;
}
.status{
    text-align: right;
    padding: 8px;
    box-sizing: border-box;
    position:absolute;
    bottom: 0;
    left:0;
    width:100%;
}
@media (max-width: 720px) {
    .levels{
        max-width: 400px;
        margin: 0 auto;
    }
}
</style>