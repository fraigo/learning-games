<!-- text-template -->
<script type="text/x-template" id="app-content-template">
    <div class="app-content">
        <h1 v-if="position!=-3">{{section.title}}</h1>
        <transition-group name="fade">
        <div class="option-container levels" :key="'levels'" v-if="currentLevel==0">
            <div v-for="(level, idx) in section.levels" :key="level.label" class="option" @click="start(idx+1)">
                <div>{{level.label}}</div>
                <div class="levelstars"><span v-if="levelStars[idx]>=1">⭐️</span><span v-if="levelStars[idx]>=2">⭐️</span><span v-if="levelStars[idx]>=3">⭐️</span></div>
            </div>
        </div>
        <div v-for="(slide,idx) in currentSlides" :key="idx" v-show="idx==position">
            <div>
                <h2>{{slide.title}}</h2>
                <div class="option-container">
                    <div class="option" :result="option.result" :key="idx1" @click="verifyOption(slide,idx1)" v-for="(option,idx1) in slide.options" :style="{order:orders[idx1]}">
                        {{option.label}}
                    </div>
                </div>
            </div>
        </div>
        </transition-group>
        <div class="results" v-if="position==-1 && currentLevel>0">
            <h2>Terminado!</h2>
            <div>
                <div>Correctas<br>{{this.correct}}</div>
                <div>Errores<br>{{this.errors}}</div>
                <div class="stars"><span v-if="stars>=1">⭐️</span><span v-if="stars>=2">⭐️</span><span v-if="stars>=3">⭐️</span></div>
            </div>
        </div>
        <div class="status" v-if="position>=0">{{position+1}} / {{total}} <span class="timer" v-if="this.timer">{{timerSeconds}}</span></div>
    </div>
</script>
<script type="text/javascript">
Vue.component('app-content', {
    template: '#app-content-template',
    data: function(){
        return {
            correct: 0,
            errors: 0,
            total: 0,
            score: 0,
            stars: 0,
            currentSlides: [],
            orders: [],
            position: -2,
            sorted: false,
            timer: false,
            currentLevel: 0,
            timerLength: 5000,
            timerSeconds: 0,
            levelStars: []
        }
    },
    props: { 
        section: Object
    },
    mounted:function(){
        this.total = this.section.slides.length
        for (var index = 0; index < 10; index++) {
            this.orders.push(Math.floor(Math.random() * 10))
        }
        console.log(this.orders)
    },
    methods: {
        menu: function() {
            this.currentLevel = 0
            this.position = -1
        },
        restart: function() {
            this.position = -3
            setTimeout(function(self){
                self.start(self.currentLevel)
            },1000,this)
        },
        start: function (level) {
            var levelData = this.section.levels[level-1]
            if (levelData.hash){
                document.location.hash="#"+levelData.hash
                return
            }
            this.position = -1
            this.sorted = levelData.sorted
            this.timer = levelData.timer
            this.currentLevel = level
            this.correct = 0
            this.errors = 0
            var tmpSlides = JSON.parse(JSON.stringify(this.section.slides))
            if (!this.sorted) {
                this.currentSlides = tmpSlides.sort(function(a,b){
                    return Math.floor(Math.random()*2) -1;
                })
            } else {
                this.currentSlides = tmpSlides
            }
            this.nextSlide()
            this.$emit('status','started')
        },
        nextSlide: function () {
            clearInterval(this.timerProc)
            if (this.position + 1 == this.currentSlides.length){
                this.endSection()
                this.position=-1
                this.$emit('status','finish')
                return
            }
            this.$emit('status','next')
            this.position++
            this.$forceUpdate()
            if (this.timer){
                this.timerSeconds=this.timer
                this.timerProc=setInterval(function (self) {
                    self.timerSeconds--
                    if (self.timerSeconds==0){
                        self.nextSlide()
                    }
                },1000, this)
            }
        },
        endSection: function () {
            var points = (this.correct-this.errors)
            this.score = points/this.total
            if (this.score == 1){
                this.stars = 3
            }
            else if (this.score >0.6){
                this.stars = 2
            }
            else if (this.score > 0.3){
                this.stars = 1
            }
            if (!this.levelStars[this.position]){
                this.levelStars[this.position]=0
            }
            this.levelStars[this.currentLevel-1] = Math.max(this.stars, this.levelStars[this.position])
            setTimeout(function(self){
                self.currentLevel = 0
            },3000, this)
        },
        verifyOption: function(slide, idx){
            var option = slide.options[idx]
            var answer = slide.answer
            var self = this
            var currentOptions=this.currentSlides[this.position].options
            if (currentOptions[idx].result>0){
                return
            }
            console.log(option.label, answer)
            if (option.label == answer) {
                currentOptions[idx].result = 1
                this.correct++
                clearInterval(this.timerProc)
                setTimeout(function () {
                    self.nextSlide()
                },800)
            } else {
                this.errors++
                currentOptions[idx].result = 2
            }
            this.$forceUpdate()
        }
    },
    computed:{
        
    },
    watch:{
    }

});
</script>
<style>
.app-content{
    margin-top: 1.6em;
    padding: 8px;
    text-align: center;
}
.app-content h2{
    font-size: 2.5em;
    display: inline-block;
    background-color: #44C;
    color: #fff;
    padding: 8px;
    border-radius: 8px;
}
.option-container{
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
}
.option-container .option{
    width: 100px;
    height: 100px;
    display: flex;
    justify-content: center;
    align-items: center;
    border: 2px solid #888;
    margin: 8px;
    border-radius: 12px;
    cursor: pointer;
    font-size: 2em;
}
.option-container .option[result='1']{
    border: 2px solid green;
    color: green;
    background-color: #dfd;
}
.option-container .option[result='2']{
    border: 2px solid red;
    color: red;
    background-color: #fdd;
}
.results{
    font-size: 1.2em;
}
.stars{
    font-size: 3rem;
}
.levels .option{
    font-size: 1.2em;
    flex-direction: column;
    justify-content: flex-start;
    padding-top: 8px;
}
.levelstars star{
    font-size: 1rem;
}
.timer{
    display: inline-block;
    width: 1.4em;
    height: 1.4em;
    font-size: 1.5em;
    border: 2px solid #44C;
    background-color: #eee;
    color: #44C;
    border-radius: 99% 99%;
    text-align:center;
}
.status{
    text-align: right;
    padding: 8px;
}
</style>